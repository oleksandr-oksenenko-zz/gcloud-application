machine:
  java:
    version: oraclejdk8
  services:
    - docker

test:
  post:
   - ./gradlew build

deployment:
  prod:
    branch: master
    commands:
      - docker build -t crew4ok/gcloud-application .
      - echo $CLIENT_SECRET | base64 --decode > ${HOME}/client-secret.json
      - gcloud auth activate-service-account --key-file ${HOME}/client-secret.json
      - gcloud config set project $GCLOUD_PROJECT
      - docker tag crew4ok/gcloud-application gcr.io/${GCLOUD_PROJECT}/gcloud-application
      - gcloud docker push gcr.io/${GCLOUD_PROJECT}/gcloud-application
      - gcloud config set compute/zone europe-west1-b
      - gcloud components install kubectl
      - gcloud container clusters get-credentials gcloud-application
      - kubectl delete rc gcloud-application
      - kubectl run --image=gcr.io/${GCLOUD_PROJECT}/gcloud-application